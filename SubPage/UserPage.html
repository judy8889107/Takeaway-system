<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/FFYIcon.ico" type="image/x-icon">
    <!-- 引用jquery -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <title>使用者資料</title>
    <script>
        var unsave = false;
        var userData;
        var newUserData; /* 紀錄使用者修改資料, 傳給後台做資料更改 */
        // 得到user data
        $.get("../phpCode/UserPage.php", function (result) {
            userData = structuredClone(result);  /* 使userData的值不會改變 */
            newUserData = result;
            setDataLabel(userData);
        }, "json");

        //設定data label
        function setDataLabel(userData) {
            console.log(userData);
            var keys = Object.keys(userData);
            var values = Object.values(userData);
            for (var i = 0; i < keys.length; i++) {
                $("#" + keys[i]).text(values[i]);
                // 針對密碼顯示做額外處理
                if (keys[i] == "password") {
                    var text = $("#" + keys[i]).text();
                    var substr = text.substring(1, text.length - 1);
                    text = text.replace(substr, "*".repeat(substr.length));
                    $("#" + keys[i]).text(text);
                }
                // 性別顯示處理
                if (keys[i] == "gender") {
                    var tmp = values[i] == "male" ? "男" : "女";
                    $("#" + keys[i]).text(tmp);
                }

            }
        }
        $(document).ready(function () {
            $("a").click(function () {
                unsave = true; /* 只要有按下修改就會是未儲存 */
                var name = $(this).attr("for");
                var toggle = $(this).attr("toggled") == "true" ? true : false;
                var preEle = $("#" + name);
                switch (name) {
                    case "nickName":
                        nickNameCheck($(this), name, toggle, preEle);
                        break;
                    case "password":
                        var inputItem;
                        passwordCheck($(this), name, toggle, preEle, inputItem);
                        break;
                    case "gender":
                        genderCheck($(this), name, toggle, preEle);
                        break;
                    case "birthday":
                        birthdayCheck($(this), name, toggle, preEle);
                        break;
                    case "phoneNumber":
                        phoneNumberCheck($(this), name, toggle, preEle);
                        break;
                    case "email":
                        var isValid = false;
                        emailCheck($(this), name, toggle, preEle, validCode, isValid);
                        break;
                    case "address":
                        addressCheck($(this), name, toggle, preEle);
                        break;

                }

            });


            // 修改檢查
            function nickNameCheck(thisEle, name, toggle, preEle) {
                if (!toggle) { /* 修改 */
                    var newEle = document.createElement("input");
                    newEle.id = name;
                    newEle.value = preEle.text();
                    preEle.replaceWith(newEle);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");

                }
                else { /* 確認 */
                    if (preEle.val().length >= 4) {
                        var newEle = document.createElement("label");
                        newEle.id = name;
                        newEle.innerHTML = preEle.val();
                        newUserData.nickName = preEle.val();
                        preEle.replaceWith(newEle);
                        thisEle.text("修改");
                        thisEle.attr("toggled", "false");
                    }
                    else {
                        alert("輸入長度請大於4");
                    }


                }

            }

            function passwordCheck(thisEle, name, toggle, preEle) {

                if (!toggle) { /* 修改 */
                    var fragment = document.createDocumentFragment(); /* 建立dom fragment */
                    inputItem = { orginPWD: "orginPWD", newPWD: "newPWD", checkPWD: "checkPWD" };
                    var placeholder = ["請輸入原本密碼", "請輸入新密碼", "確認新密碼"];
                    for (var i = 0; i < 3; i++) {
                        var newEle = document.createElement("input");
                        newEle.id = Object.values(inputItem)[i];
                        newEle.placeholder = placeholder[i];
                        newEle.type = "password";
                        inputItem[Object.keys(inputItem)[i]] = newEle;
                        fragment.appendChild(newEle);
                    }
                    console.log(inputItem);
                    preEle.replaceWith(fragment);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");

                }
                else { /* 確認 */
                    var orginPWD = inputItem.orginPWD.value;
                    var newPWD = inputItem.newPWD.value;
                    var checkPWD = inputItem.checkPWD.value;
                    //輸入檢查
                    if (userData.password == orginPWD) {
                        if (newPWD == checkPWD) {
                            if (newPWD.length >= 8) {
                                var newEle = document.createElement("label");
                                newEle.id = name;
                                newUserData.password = newPWD;
                                //密碼隱私處理
                                var substr = newPWD.substring(1, newPWD.length - 1);
                                newPWD = newPWD.replace(substr, "*".repeat(substr.length));
                                newEle.innerHTML = newPWD;
                                //--

                                inputItem.newPWD.remove();
                                inputItem.checkPWD.remove();
                                inputItem.orginPWD.replaceWith(newEle);
                                thisEle.text("修改");
                                thisEle.attr("toggled", "true");


                            } else {
                                alert("新密碼長度需大於8，請重新輸入");
                            }

                        }
                        else {
                            alert("新密碼輸入不一致，請重新輸入")
                        }
                    }
                    else {
                        alert("和原本密碼不一致，請重新輸入")
                    }




                }


            }


            function genderCheck(thisEle, name, toggle, preEle) {
                var option = { male: "男", female: "女" };
                if (!toggle) {
                    var fragment = document.createDocumentFragment(); /* 建立dom fragment */
                    var selectEle = document.createElement("select");
                    selectEle.id = name;
                    for (i = 0; i < 2; i++) {
                        var newEle = document.createElement("option");
                        newEle.value = Object.keys(option)[i];
                        newEle.text = Object.values(option)[i];
                        selectEle.append(newEle);
                    }
                    preEle.replaceWith(selectEle);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");

                } else {
                    var selectVal = $("#" + name).val();
                    var newEle = document.createElement("label");
                    newEle.id = name;
                    // console.log(selectVal);
                    // console.log(option[selectVal]);
                    newUserData.gender = selectVal;
                    newEle.innerHTML = option[selectVal];
                    preEle.replaceWith(newEle);
                    thisEle.text("修改");
                    thisEle.attr("toggled", "false");

                }
            }

            function birthdayCheck(thisEle, name, toggle, preEle) {
                if (!toggle) {
                    var newEle = document.createElement("input");
                    newEle.id = name;
                    newEle.type = "date";
                    preEle.replaceWith(newEle);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");


                } else {
                    var newEle = document.createElement("label");
                    newEle.id = name;
                    newEle.innerHTML = preEle.val();
                    newUserData.birthday = preEle.val();
                    preEle.replaceWith(newEle);
                    thisEle.text("修改");
                    thisEle.attr("toggled", "false");
                }
            }

            function phoneNumberCheck(thisEle, name, toggle, preEle) {
                if (!toggle) {
                    var newEle = document.createElement("input");
                    newEle.id = name;
                    newEle.type = "tel";
                    newEle.placeholder = "0912345678";
                    preEle.replaceWith(newEle);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");


                } else {
                    var inputVal = preEle.val();
                    if (inputVal.match("^09[0-9]{8}") && inputVal.length == 10) {
                        // 若輸入的不是自己原號碼, 進入後台檢查有無重複   
                        if (inputVal != userData.phoneNumber) {
                            $.get("../phpCode/UserPageCheckRepeat.php", { phoneNumber: inputVal }, function (result) {
                                isRepeat = result == "true" ? true : false;
                                if (!isRepeat) {
                                    var newEle = document.createElement("label");
                                    newEle.id = name;
                                    newEle.innerHTML = preEle.val();
                                    newUserData.phoneNumber = preEle.val();
                                    preEle.replaceWith(newEle);
                                    thisEle.text("修改");
                                    thisEle.attr("toggled", "false");
                                } else {
                                    alert("已有存在的手機號碼，請重新輸入");
                                }
                            }, "text");
                        }
                    } else {
                        alert("電話號碼格式有誤，請重新輸入");
                    }

                }
            }

            var validCode; /* 把validCode宣告在外部 */
            function emailCheck(thisEle, name, toggle, preEle) {
                var validReg = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/; /* 電子郵件正則表達 */
                if (!toggle) {
                    isValid = false;
                    var fragment = document.createDocumentFragment(); /* 建立dom fragment */
                    var newEle = document.createElement("input");
                    var newBtn = document.createElement("button");
                    var inputValidCode = document.createElement("input");
                    newEle.id = name;
                    newEle.placeholder = "email@example.com";
                    newBtn.id = "emailValid";
                    newBtn.innerHTML = "驗證電子郵件";
                    inputValidCode.id = "inputValidCode";
                    inputValidCode.placeholder = "請輸入驗證碼";
                    inputValidCode.readOnly = true;
                    // 加入按鈕監聽事件
                    newBtn.addEventListener("click", function (e) {
                        isValid = false;

                        var inputVal = $("#email").val();
                        if (inputVal == userData.email) {
                            alert("此Email已經驗證過了，無須驗證");
                            isValid = true;
                        } else {
                            if (inputVal.match(validReg)) {
                                isValid = false;
                                $.get("../phpCode/UserPageCheckRepeat.php", { email: inputVal }, function (result) {
                                    isRepeat = result == "true" ? true : false;
                                    if (!isRepeat) { /* 若無重複的Email則送出驗證信 */
                                        $("#inputValidCode").removeAttr("readOnly"); /* 可輸入驗證碼input框 */

                                        // 按鈕倒數計時 30s
                                        $t = 30;
                                        $("#emailValid").prop("disabled", true); /* 驗證電子郵件按鈕設為30s不可用 */
                                        var interval = setInterval(function () {
                                            // console.log($t + "\n"); /* 測試用 */
                                            $t -= 1;
                                            if ($t <= 0) {
                                                $("#emailValid").prop("disabled", false);
                                                $("#emailValid").text("重新傳送");
                                                clearInterval(interval);
                                            } else {
                                                $str = "重新傳送(" + String($t) + ")";
                                                $("#emailValid").text($str);
                                            }

                                        }, 1000);


                                        $.get("../phpCode/UserPageCheckRepeat.php", { sendEmail: inputVal }, function (result) {
                                            validCode = result;
                                            console.log("信箱: " + inputVal); /* 測試用 */
                                            console.log("驗證碼: " + validCode); /* 測試用 */
                                        }, "text");
                                    }
                                    else {

                                        alert("已有存在的Email，請重新輸入");
                                    }
                                }, "text");
                            } else {
                                alert("Email格式錯誤，請重新輸入");
                            }

                        }


                    });
                    fragment.appendChild(newEle);
                    fragment.appendChild(newBtn);
                    fragment.appendChild(inputValidCode);
                    preEle.replaceWith(fragment);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");


                } else {
                    var inputVal = $("#inputValidCode").val();
                    // isValid動態變化
                    if (!isValid) {
                        if (inputVal == validCode) { /* 若輸入的驗證碼相符 */
                            isValid = true;
                        }
                    }

                    // 判斷isValid
                    if (isValid) {
                        var newEle = document.createElement("label");
                        newEle.id = name;
                        newEle.innerHTML = $("#email").val();
                        newUserData.email = $("#email").val();
                        $("#emailValid").remove();
                        $("#inputValidCode").remove();
                        preEle.replaceWith(newEle);
                        thisEle.text("修改");
                        thisEle.attr("toggled", "false");
                    }
                    else {
                        alert("驗證碼不相符，請重新輸入");
                    }


                }
            }

            function addressCheck(thisEle, name, toggle, preEle) {

                if (!toggle) { /* 修改 */

                    var newEle = document.createElement("input");
                    newEle.id = name;
                    newEle.value = preEle.text();
                    preEle.replaceWith(newEle);
                    thisEle.text("確認");
                    thisEle.attr("toggled", "true");

                }
                else { /* 確認 */
                    var validReg = /[a-z]+/i;
                    var inputVal = preEle.val();
                    // 地址不包含英文字母
                    if (!inputVal.match(validReg)) {
                        var newEle = document.createElement("label");
                        newEle.id = name;
                        newEle.innerHTML = inputVal;
                        newUserData.address = inputVal;
                        preEle.replaceWith(newEle);
                        thisEle.text("修改");
                        thisEle.attr("toggled", "false");
                    } else {
                        alert("地址格式錯誤，請重新輸入");
                    }



                }
            }

            // 儲存按鈕
            $("#saveData").click(function () {
                unsave = true;
                console.log(newUserData);
                // 判斷是否都有確認了
                // console.log($("input").length);
                // console.log($("select").length);
                if ($("input").length != 2 || $("select").length != 0) {
                    alert("尚有未確認的欄位，請確認後再儲存");
                }
                else {
                    $.get("../phpCode/saveData.php", newUserData, function (result) {
                        console.log(newUserData);
                        console.log("修改成功:" + result);

                    }, "text");
                    isSave = true;
                }


            });

            // 回上一頁按鈕
            $("#prePage").click(function () {
                if (unsave) {
                    var dialog = confirm("您有尚未儲存的資料，請問是否返回上一頁？");
                    if (dialog) {
                        console.log('是')
                        $(location).prop("href", "HomePage.html"); /* 不儲存返回首頁 */
                    }
                    else {
                        console.log('否');
                        // 停留在此頁
                    }
                }else{
                    $(location).prop("href", "HomePage.html"); /* 無更改返回首頁 */
                }

            });

        });





    </script>
</head>

<body>
    <form id="userDataForm">
        <label for="nickName">暱稱:</label>
        <label name="nickName" id="nickName"></label>
        <a for="nickName" href="#" toggled="false">修改</a>
        <br />
        <label>帳號:</label>
        <label name="userName" id="userName"></label>
        <br />
        <label>密碼:</label>
        <label name="password" id="password"></label>
        <a for="password" href="#">修改</a>
        <br />
        <label>性別:</label>
        <label name="gender" id="gender"></label>
        <a for="gender" href="#">修改</a>
        <br />
        <label>生日:</label>
        <label name="birthday" id="birthday"></label>
        <a for="birthday" href="#">修改</a>
        <br />
        <label>手機號碼:</label>
        <label name="phoneNumber" id="phoneNumber"></label>
        <a for="phoneNumber" href="#">修改</a>
        <br />
        <label>Email:</label>
        <label name="email" id="email"></label>
        <a for="email" href="#">修改</a>
        <br />
        <label>地址:</label>
        <label name="address" id="address"></label>
        <a for="address" href="#">修改</a>
        <br />
        <input id="saveData" type="submit" value="儲存"></input>
        <input id="prePage" type="button" value="回上一頁"></input>
    </form>
</body>

</html>